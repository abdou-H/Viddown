const translations = {
  ar: {
    title: "Ø£Ø¯Ø§Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª",
    placeholder: "Ø¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§",
    button: "ØªØ­Ù…ÙŠÙ„",
    status_start: "ðŸ“¥ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
    status_done: "âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„!",
    status_error: "âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„",
    status_server_error: "âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…"
  },
  en: {
    title: "Video Downloader Tool",
    placeholder: "Paste the URL here",
    button: "Download",
    status_start: "ðŸ“¥ Downloading...",
    status_done: "âœ… Download complete!",
    status_error: "âš ï¸ Download failed",
    status_server_error: "âŒ Server error"
  },
  fr: {
    title: "Outil de tÃ©lÃ©chargement vidÃ©o",
    placeholder: "Collez le lien ici",
    button: "TÃ©lÃ©charger",
    status_start: "ðŸ“¥ TÃ©lÃ©chargement en cours...",
    status_done: "âœ… TÃ©lÃ©chargement terminÃ© !",
    status_error: "âš ï¸ Ã‰chec du tÃ©lÃ©chargement",
    status_server_error: "âŒ Erreur du serveur"
  },
  de: {
    title: "Video-Download-Tool",
    placeholder: "FÃ¼gen Sie den Link hier ein",
    button: "Herunterladen",
    status_start: "ðŸ“¥ Wird heruntergeladen...",
    status_done: "âœ… Heruntergeladen!",
    status_error: "âš ï¸ Download fehlgeschlagen",
    status_server_error: "âŒ Serverfehler"
  },
  es: {
    title: "Herramienta para descargar videos",
    placeholder: "Pega el enlace aquÃ­",
    button: "Descargar",
    status_start: "ðŸ“¥ Descargando...",
    status_done: "âœ… Descarga completa!",
    status_error: "âš ï¸ FallÃ³ la descarga",
    status_server_error: "âŒ Error del servidor"
  },
  zh: {
    title: "è§†é¢‘ä¸‹è½½å·¥å…·",
    placeholder: "è¯·åœ¨æ­¤ç²˜è´´é“¾æŽ¥",
    button: "ä¸‹è½½",
    status_start: "ðŸ“¥ æ­£åœ¨ä¸‹è½½...",
    status_done: "âœ… ä¸‹è½½å®Œæˆï¼",
    status_error: "âš ï¸ ä¸‹è½½å¤±è´¥",
    status_server_error: "âŒ æœåŠ¡å™¨é”™è¯¯"
  },
  tr: {
    title: "Video Ä°ndirme AracÄ±",
    placeholder: "BaÄŸlantÄ±yÄ± buraya yapÄ±ÅŸtÄ±rÄ±n",
    button: "Ä°ndir",
    status_start: "ðŸ“¥ Ä°ndiriliyor...",
    status_done: "âœ… Ä°ndirme tamamlandÄ±!",
    status_error: "âš ï¸ Ä°ndirme baÅŸarÄ±sÄ±z",
    status_server_error: "âŒ Sunucu hatasÄ±"
  },
  hi: {
    title: "à¤µà¥€à¤¡à¤¿à¤¯à¥‹ à¤¡à¤¾à¤‰à¤¨à¤²à¥‹à¤¡ à¤Ÿà¥‚à¤²",
    placeholder: "à¤¯à¤¹à¤¾à¤ à¤²à¤¿à¤‚à¤• à¤ªà¥‡à¤¸à¥à¤Ÿ à¤•à¤°à¥‡à¤‚",
    button: "à¤¡à¤¾à¤‰à¤¨à¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚",
    status_start: "ðŸ“¥ à¤¡à¤¾à¤‰à¤¨à¤²à¥‹à¤¡ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆ...",
    status_done: "âœ… à¤¡à¤¾à¤‰à¤¨à¤²à¥‹à¤¡ à¤ªà¥‚à¤°à¤¾!",
    status_error: "âš ï¸ à¤¡à¤¾à¤‰à¤¨à¤²à¥‹à¤¡ à¤µà¤¿à¤«à¤²",
    status_server_error: "âŒ à¤¸à¤°à¥à¤µà¤° à¤¤à¥à¤°à¥à¤Ÿà¤¿"
  },
  ru: {
    title: "Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð²Ð¸Ð´ÐµÐ¾",
    placeholder: "Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÑÑÑ‹Ð»ÐºÑƒ ÑÑŽÐ´Ð°",
    button: "Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ",
    status_start: "ðŸ“¥ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...",
    status_done: "âœ… Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!",
    status_error: "âš ï¸ Ð¡Ð±Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸",
    status_server_error: "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°"
  }
};

function changeLanguage(lang) {
  const t = translations[lang] || translations.en;

  // Update HTML lang attribute for accessibility
  document.documentElement.lang = lang;

  document.getElementById("title").textContent = t.title;
  document.getElementById("url").placeholder = t.placeholder;
  document.getElementById("download-btn").textContent = t.button;

  localStorage.setItem("lang", lang);
}

function onLangSelectChange() {
  const selectedLang = document.getElementById("lang").value;
  changeLanguage(selectedLang);
}

async function downloadMedia() {
  const urlInput = document.getElementById('url');
  const format = document.getElementById('format').value;
  const status = document.getElementById('status');
  const bar = document.getElementById('progress-bar');
  const inner = document.getElementById('progress-inner');
  const downloadBtn = document.getElementById('download-btn');
  const lang = document.getElementById("lang").value;
  const t = translations[lang] || translations.en;

  if (!urlInput.value) {
    status.textContent = t.placeholder; // Prompt user to enter a URL
    return;
  }

  bar.style.display = 'block';
  inner.style.width = '0%';
  status.textContent = t.status_start;
  downloadBtn.disabled = true; // Disable button during download

  const evtSource = new EventSource('/progress');
  evtSource.onmessage = (e) => {
    inner.style.width = e.data + '%';
  };

  try {
    const res = await fetch('/api/download', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url: urlInput.value, format }),
    });

    evtSource.close();

    if (!res.ok) {
      const errorData = await res.json();
      // Display detailed error from server if available
      status.textContent = `${t.status_error}: ${errorData.details || ''}`;
      inner.style.width = '0%';
      bar.style.display = 'none';
      return;
    }

    inner.style.width = '100%';
    const blob = await res.blob();
    const downloadUrl = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = downloadUrl;
    
    // Create a better filename
    const filename = (urlInput.value.split('v=')[1] || `media_${Date.now()}`).split('&')[0];
    a.download = `${filename}.${format}`;
    
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(downloadUrl);
    
    status.textContent = t.status_done;
    urlInput.value = ''; // Clear input on success
  } catch (err) {
    evtSource.close();
    status.textContent = t.status_server_error;
    console.error("Download error:", err);
  } finally {
    downloadBtn.disabled = false; // Re-enable button
  }
}

// Set up event listeners and initial language when the page loads
window.onload = () => {
  let savedLang = localStorage.getItem("lang");

  if (!savedLang) {
    const browserLang = navigator.language.slice(0, 2);
    savedLang = translations[browserLang] ? browserLang : "en";
  }

  document.getElementById("lang").value = savedLang;
  changeLanguage(savedLang);

  // Attach event listeners using modern JS
  document.getElementById("lang").addEventListener("change", onLangSelectChange);
  document.getElementById("download-btn").addEventListener("click", downloadMedia);
};
